{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å GigaChat - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        border: 2px solid #ddd;
        border-radius: 15px;
        overflow: hidden;
        background: #f8f9fa;
    }

    .chat-header {
        background: #3498db;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-status {
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        padding: 15px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .message-user {
        background: #3498db;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    .message-bot {
        background: white;
        color: #333;
        align-self: flex-start;
        border: 1px solid #ddd;
        border-bottom-left-radius: 5px;
    }

    .message-sources {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #3498db;
    }

    .source-item {
        background: white;
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 12px;
        border-left: 3px solid #27ae60;
    }

    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #ddd;
    }

    .chat-input-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        min-height: 44px;
        resize: vertical;
        max-height: 120px;
    }

    .chat-options {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .system-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .info-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        border-left: 4px solid #3498db;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .info-card h3 {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .typing-indicator {
        display: none;
        padding: 15px;
        background: white;
        border-radius: 15px;
        align-self: flex-start;
        border: 1px solid #ddd;
        border-bottom-left-radius: 5px;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3498db;
        animation: typing 1.5s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 80%, 100% {
            opacity: 0.3;
        }
        40% {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="system-info">
    <div class="info-card">
        <h3>ü§ñ –°—Ç–∞—Ç—É—Å GigaChat</h3>
        <div class="chat-status">
            <span class="status-indicator {% if gigachat_available %}status-online{% else %}status-offline{% endif %}"></span>
            {% if gigachat_available %}
                –ü–æ–¥–∫–ª—é—á–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
            {% else %}
                –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã)
            {% endif %}
        </div>
    </div>

    <div class="info-card">
        <h3>üìö –°—Ç–∞—Ç—É—Å RAG –±–∞–∑—ã</h3>
        <div class="chat-status">
            <span class="status-indicator {% if rag_available %}status-online{% else %}status-offline{% endif %}"></span>
            {% if rag_available %}
                –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω–∞
            {% else %}
                –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ GigaChat —ç–º–±–µ–¥–¥–∏–Ω–≥–∏)
            {% endif %}
        </div>
    </div>
</div>

<!-- Navigation Links -->
<div style="text-align: center; margin: 20px 0;">
    <a href="/manual" style="display: inline-block; padding: 12px 24px; background: #3498db; color: white; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; transition: background 0.3s;">
        üìñ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    </a>
    <a href="/admin" style="display: inline-block; padding: 12px 24px; background: #27ae60; color: white; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; transition: background 0.3s;">
        ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    </a>
</div>

{% if not gigachat_available %}
<div class="alert alert-warning">
    ‚ö†Ô∏è GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ certificates/ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.
</div>
{% endif %}

{% if not rag_available %}
<div class="alert alert-warning">
    ‚ö†Ô∏è RAG –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GigaChat —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
</div>
{% endif %}

<div class="chat-container">
    <div class="chat-header">
        <h3>üí¨ –ß–∞—Ç —Å GigaChat</h3>
        <div class="chat-status">
            <span class="status-indicator {% if gigachat_available %}status-online{% else %}status-offline{% endif %}"></span>
            {% if gigachat_available %}–û–Ω–ª–∞–π–Ω{% else %}–û—Ñ–ª–∞–π–Ω{% endif %}
        </div>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="message message-bot">
            –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –±–∞–∑–µ GigaChat. 
            {% if rag_available %}
            –ú–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–ª–∏ –±–µ–∑ –Ω–µ—ë.
            {% else %}
            –ü–æ–∫–∞ —á—Ç–æ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –Ω–æ —è –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.
            {% endif %}
            –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        <span style="margin-left: 10px;">GigaChat –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
    </div>

    <div class="chat-input-container">
        <div class="chat-options">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="useRag" checked {% if not rag_available %}disabled{% endif %}>
                <label for="useRag">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</label>
            </div>
            {% if not rag_available %}
            <small style="color: #666;">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</small>
            {% endif %}
        </div>

        <form class="chat-input-form" id="chatForm">
            <textarea 
                class="form-control chat-input" 
                id="messageInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." 
                rows="1"
                {% if not gigachat_available %}disabled{% endif %}
            ></textarea>
            <button 
                type="submit" 
                class="btn btn-primary"
                id="sendButton"
                {% if not gigachat_available %}disabled{% endif %}
            >
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const useRagCheckbox = document.getElementById('useRag');
    const sendButton = document.getElementById('sendButton');

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addMessage(message, 'user');
        messageInput.value = '';
        messageInput.style.height = 'auto';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showTyping(true);
        sendButton.disabled = true;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    use_rag: useRagCheckbox.checked
                })
            });

            const data = await response.json();

            if (response.ok) {
                addMessage(data.response, 'bot', data.sources);
            } else {
                addMessage(`–û—à–∏–±–∫–∞: ${data.detail}`, 'bot');
            }
        } catch (error) {
            addMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'bot');
        } finally {
            showTyping(false);
            sendButton.disabled = false;
            messageInput.focus();
        }
    });

    function addMessage(content, sender, sources = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º markdown –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –±–æ—Ç–∞
        if (sender === 'bot') {
            messageDiv.innerHTML = formatMarkdown(content);
        } else {
            messageDiv.textContent = content;
        }

        chatMessages.appendChild(messageDiv);

        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (sources && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'message-sources';
            sourcesDiv.innerHTML = '<strong>üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</strong>';
            
            sources.forEach(source => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'source-item';
                sourceDiv.innerHTML = `
                    <div><strong>${source.metadata.title || '–î–æ–∫—É–º–µ–Ω—Ç'}</strong></div>
                    <div>${source.text}</div>
                    <div style="color: #666; font-size: 11px;">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${(source.score * 100).toFixed(1)}%</div>
                `;
                sourcesDiv.appendChild(sourceDiv);
            });
            
            chatMessages.appendChild(sourcesDiv);
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping(show) {
        typingIndicator.style.display = show ? 'flex' : 'none';
        if (show) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function formatMarkdown(text) {
        // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ markdown
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
    }
});
</script>
{% endblock %}
