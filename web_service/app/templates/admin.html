{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .admin-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3498db;
    }

    .admin-card h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
    }

    .form-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .form-section h4 {
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .full-width {
        grid-column: 1 / -1;
    }

    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
    }

    .file-upload-area:hover {
        border-color: #3498db;
        background: #e3f2fd;
    }

    .file-upload-area.dragover {
        border-color: #2980b9;
        background: #bbdefb;
    }

    .upload-icon {
        font-size: 3em;
        color: #ddd;
        margin-bottom: 15px;
    }

    .file-list {
        margin-top: 15px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 5px;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: #27ae60;
        transition: width 0.3s;
    }

    .confluence-test-result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 10px;
        display: none;
    }

    .form-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    .alert {
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
        font-family: monospace;
        font-size: 13px;
    }

    .form-check {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .form-check-input {
        width: 18px;
        height: 18px;
        margin-top: 2px;
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
        font-weight: 500;
        color: #495057;
        line-height: 1.4;
    }

    .form-check .form-text {
        margin-top: 5px;
        margin-left: 0;
        display: block;
        color: #6c757d;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .tab-button {
        padding: 10px 20px;
        background: #e9ecef;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-button.active {
        background: #3498db;
        color: white;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ */
    .console-container {
        background: #1e1e1e;
        border-radius: 10px;
        padding: 0;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .console-header {
        background: #323232;
        padding: 15px 20px;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .console-title {
        color: #fff;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .console-controls {
        display: flex;
        gap: 10px;
    }

    .console-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
    }

    .console-btn.clear {
        background: #e74c3c;
        color: white;
    }

    .console-btn.pause {
        background: #f39c12;
        color: white;
    }

    .console-btn.resume {
        background: #27ae60;
        color: white;
    }

    .console-output {
        max-height: 500px;
        overflow-y: auto;
        padding: 15px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
        background: #1e1e1e;
        color: #d4d4d4;
    }

    .log-entry {
        margin-bottom: 8px;
        padding: 5px 8px;
        border-radius: 4px;
        border-left: 3px solid transparent;
        word-wrap: break-word;
    }

    .log-entry.INFO {
        border-left-color: #3498db;
        background: rgba(52, 152, 219, 0.1);
    }

    .log-entry.WARNING {
        border-left-color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
    }

    .log-entry.ERROR {
        border-left-color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
    }

    .log-entry.DEBUG {
        border-left-color: #9b59b6;
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
    }

    .log-timestamp {
        color: #7f8c8d;
        font-size: 11px;
        margin-right: 10px;
    }

    .log-logger {
        color: #95a5a6;
        font-size: 11px;
        margin-right: 10px;
    }

    .log-message {
        color: inherit;
    }

    .console-status {
        padding: 10px 20px;
        background: #2c3e50;
        color: #ecf0f1;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.connected {
        background: #27ae60;
        box-shadow: 0 0 5px #27ae60;
    }

    .status-dot.disconnected {
        background: #e74c3c;
        box-shadow: 0 0 5px #e74c3c;
    }

    .auto-scroll-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
    }

    .auto-scroll-toggle input[type="checkbox"] {
        width: 14px;
        height: 14px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–µ–ª–µ–π */
    .model-grid {
        display: grid;
        gap: 15px;
        margin-top: 15px;
    }

    .model-card {
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

    .model-card:hover {
        border-color: #3498db;
        box-shadow: 0 2px 10px rgba(52, 152, 219, 0.2);
    }

    .model-card.active {
        border-color: #27ae60;
        background: #f0fff4;
        box-shadow: 0 2px 10px rgba(39, 174, 96, 0.2);
    }

    .model-card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .model-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .model-name {
        font-weight: bold;
        color: #2c3e50;
    }

    .model-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .model-badge.default {
        background: #3498db;
        color: white;
    }

    .model-badge.active {
        background: #27ae60;
        color: white;
    }

    .model-description {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #3498db;
    }

    .model-description h5 {
        margin: 0 0 8px 0;
        color: #2c3e50;
    }

    .model-description p {
        margin: 0;
        line-height: 1.4;
    }

    .model-info {
        display: grid;
        gap: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Links -->
<div style="text-align: center; margin-bottom: 20px;">
    <a href="/" style="display: inline-block; padding: 12px 24px; background: #3498db; color: white; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; transition: background 0.3s;">
        üè† –ì–ª–∞–≤–Ω–∞—è
    </a>
    <a href="/manual" style="display: inline-block; padding: 12px 24px; background: #9b59b6; color: white; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; transition: background 0.3s;">
        üìñ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
    </a>
</div>

<div class="stats-grid">
    <div class="stat-item">
        <div class="stat-number">{{ stats.total_documents }}</div>
        <div class="stat-label">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ stats.total_chunks }}</div>
        <div class="stat-label">–§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ stats.confluence_pages }}</div>
        <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü Confluence</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ stats.uploaded_files }}</div>
        <div class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>
    </div>
</div>

<div class="tab-buttons">
    <button class="tab-button active" onclick="switchTab('confluence')">üåê Confluence</button>
    <button class="tab-button" onclick="switchTab('files')">üìÅ –§–∞–π–ª—ã</button>
    <button class="tab-button" onclick="switchTab('models')">ü§ñ –ú–æ–¥–µ–ª–∏</button>
    <button class="tab-button" onclick="switchTab('database')">üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</button>
    <button class="tab-button" onclick="switchTab('maintenance')">üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
    <button class="tab-button" onclick="switchTab('console')">üñ•Ô∏è –ö–æ–Ω—Å–æ–ª—å</button>
</div>

<div id="confluenceTab" class="tab-content active">
    <div class="admin-card">
        <h3>üåê –ü–∞—Ä—Å–∏–Ω–≥ Confluence</h3>
        
        <form id="confluenceForm">
            <div class="form-section">
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h4>
                <div class="form-row">
                    <div>
                        <label class="form-label">URL Confluence</label>
                        <input type="url" class="form-control" id="confluenceUrl" 
                               placeholder="https://company.atlassian.net/wiki" required>
                    </div>
                    <div>
                        <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" class="form-control" id="confluenceUsername" 
                               placeholder="user@company.com" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label class="form-label">–ü–∞—Ä–æ–ª—å/API Token</label>
                        <input type="password" class="form-control" id="confluencePassword" 
                               placeholder="API Token –∏–ª–∏ –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <div>
                        <label class="form-label">–ú–∞–∫—Å–∏–º—É–º —Å—Ç—Ä–∞–Ω–∏—Ü</label>
                        <input type="number" class="form-control" id="maxPages" 
                               value="50" min="1" max="1000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="verifySSL" checked>
                            <label class="form-check-label" for="verifySSL">
                                üîí –ü—Ä–æ–≤–µ—Ä—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
                            </label>
                            <small class="form-text text-muted">–û—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ä–µ–¥ —Å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏</small>
                        </div>
                    </div>
                    <div>
                        <!-- –ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>–ò—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç—Ä–∞–Ω–∏—Ü</h4>
                <div class="form-row">
                    <div>
                        <label class="form-label">–ö–ª—é—á –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (Space Key)</label>
                        <input type="text" class="form-control" id="spaceKey" 
                               placeholder="PROJ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)">
                    </div>
                    <div>
                        <label class="form-label">ID —Å—Ç—Ä–∞–Ω–∏—Ü (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                        <input type="text" class="form-control" id="pageIds" 
                               placeholder="123456,789012 (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                        <textarea class="form-control" id="pageUrls" rows="4" 
                                placeholder="https://company.atlassian.net/wiki/spaces/PROJ/pages/123456/Page+Title
https://company.atlassian.net/wiki/display/PROJ/Another+Page
https://company.atlassian.net/wiki/pages/viewpage.action?pageId=789012"></textarea>
                        <small class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã URL Confluence</small>
                    </div>
                    <div>
                        <label class="form-label">–£—Ä–æ–≤–Ω–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ—á–µ—Ä–Ω–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü</label>
                        <select class="form-control" id="parseLevels">
                            <option value="1">1 —É—Ä–æ–≤–µ–Ω—å (—Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)</option>
                            <option value="2">2 —É—Ä–æ–≤–Ω—è (+ –ø—Ä—è–º—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ)</option>
                            <option value="3">3 —É—Ä–æ–≤–Ω—è (+ –¥–æ—á–µ—Ä–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö)</option>
                            <option value="4">4 —É—Ä–æ–≤–Ω—è</option>
                            <option value="5">5 —É—Ä–æ–≤–Ω–µ–π (–º–∞–∫—Å–∏–º—É–º)</option>
                        </select>
                        <small class="form-text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞</small>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="testConfluenceConnection()">
                    –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                </button>
                <button type="submit" class="btn btn-primary">
                    –ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
                </button>
            </div>
        </form>

        <div id="confluenceResult" class="confluence-test-result"></div>
        
        <div id="confluenceProgress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="confluenceProgressBar"></div>
            </div>
            <div id="confluenceStatus">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
        </div>
    </div>
</div>

<div id="filesTab" class="tab-content">
    <div class="admin-card">
        <h3>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h3>
        
        <div class="file-upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <h4>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h4>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOCX, DOC, TXT</p>
            <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 MB</p>
            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
            </button>
        </div>

        <div id="fileList" class="file-list"></div>
    </div>
</div>

<div id="modelsTab" class="tab-content">
    <div class="admin-card">
        <h3>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ GigaChat</h3>
        
        <div class="form-section">
            <h4>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="currentModel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="modelStatus">üîÑ</div>
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏</h4>
            <div id="modelsContainer">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π...</p>
            </div>
        </div>

        <div class="form-section">
            <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª—è—Ö</h4>
            <div class="model-info">
                <div class="model-description">
                    <h5>üîµ GigaChat-2</h5>
                    <p>–ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á. –ë—ã—Å—Ç—Ä–∞—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ–±—â–µ–Ω–∏—è.</p>
                </div>
                <div class="model-description">
                    <h5>‚≠ê GigaChat-2-Pro</h5>
                    <p>–£—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á.</p>
                </div>
                <div class="model-description">
                    <h5>üöÄ GigaChat-2-Max</h5>
                    <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="databaseTab" class="tab-content">
    <div class="admin-card">
        <h3>üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h3>
        
        <div class="form-section">
            <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="dbTotalChunks">{{ stats.total_chunks }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="dbTotalDocs">{{ stats.total_documents }}</div>
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>–î–µ–π—Å—Ç–≤–∏—è</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="refreshStats()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>
                <button class="btn btn-danger" onclick="clearDatabase()" 
                        onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </div>
    </div>
</div>

<div id="maintenanceTab" class="tab-content">
    <div class="admin-card">
        <h3>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h3>
        
        <div class="form-section">
            <h4>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="systemStatus">üîÑ</div>
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å RAG</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="embeddingStatus">üîÑ</div>
                    <div class="stat-label">Embedding Provider</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="chromaStatus">üîÑ</div>
                    <div class="stat-label">ChromaDB</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="dbSize">0 MB</div>
                    <div class="stat-label">–†–∞–∑–º–µ—Ä –ë–î</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="runSystemDiagnostics()">
                    üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                </button>
                <button class="btn btn-secondary" onclick="checkEmbeddingHealth()">
                    üß† –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Embeddings
                </button>
                <button class="btn btn-secondary" onclick="debugGigaChat()">
                    üêõ –û—Ç–ª–∞–¥–∫–∞ GigaChat
                </button>
                <button class="btn btn-secondary" onclick="validateDatabase()">
                    ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ë–î
                </button>
                <button class="btn btn-warning" onclick="checkEmbeddingCompatibility()">
                    ‚öôÔ∏è –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Embeddings
                </button>
                <button class="btn btn-danger" onclick="migrateEmbeddings()">
                    üîÑ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Embeddings
                </button>
                <button class="btn btn-warning" onclick="checkMaintenanceNeeds()">
                    üîß –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
                </button>
            </div>
            
            <div id="diagnosticsResult" class="alert" style="display: none;">
                <h5>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</h5>
                <div id="diagnosticsContent"></div>
            </div>
        </div>

        <div class="form-section">
            <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-info" onclick="exportDatabaseInfo()">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-secondary" onclick="viewDocumentSources()">
                    üìë –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                </button>
                <button class="btn btn-secondary" onclick="analyzeChunkDistribution()">
                    üìä –ê–Ω–∞–ª–∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
                </button>
            </div>
        </div>

        <div class="form-section">
            <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é</h4>
            <div id="maintenanceRecommendations" class="model-description">
                <h5>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</h5>
                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...</p>
            </div>
        </div>
    </div>
</div>

<div id="consoleTab" class="tab-content">
    <div class="admin-card">
        <h3>üñ•Ô∏è –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤</h3>
        
        <div class="console-container">
            <div class="console-header">
                <div class="console-title">
                    üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                </div>
                <div class="console-controls">
                    <button class="console-btn pause" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                    <button class="console-btn clear" onclick="clearConsole()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div class="console-output" id="consoleOutput">
                <div class="log-entry INFO">
                    <span class="log-timestamp">--:--:--.---</span>
                    <span class="log-logger">[system]</span>
                    <span class="log-message">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –ª–æ–≥–∞–º...</span>
                </div>
            </div>
            <div class="console-status">
                <div class="status-indicator">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
                <div class="auto-scroll-toggle">
                    <input type="checkbox" id="autoScroll" checked>
                    <label for="autoScroll">–ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞</label>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <p>–≠—Ç–∞ –∫–æ–Ω—Å–æ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –í—ã —É–≤–∏–¥–∏—Ç–µ:</p>
            <ul>
                <li>üîµ <strong>INFO</strong> - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</li>
                <li>üü° <strong>WARNING</strong> - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
                <li>üî¥ <strong>ERROR</strong> - –æ—à–∏–±–∫–∏</li>
                <li>üü£ <strong>DEBUG</strong> - –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Confluence
async function testConfluenceConnection() {
    const url = document.getElementById('confluenceUrl').value;
    const username = document.getElementById('confluenceUsername').value;
    const password = document.getElementById('confluencePassword').value;
    const verifySSL = document.getElementById('verifySSL').checked;

    if (!url || !username || !password) {
        showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
        return;
    }

    const resultDiv = document.getElementById('confluenceResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'confluence-test-result alert alert-warning';
    resultDiv.innerHTML = `üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è... ${!verifySSL ? '(SSL –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞)' : ''}`;

    try {
        const response = await fetch('/api/confluence/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                username: username,
                password: password,
                verify_ssl: verifySSL
            })
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'confluence-test-result alert alert-success';
            resultDiv.innerHTML = `‚úÖ ${result.message}`;
        } else {
            resultDiv.className = 'confluence-test-result alert alert-error';
            resultDiv.innerHTML = `‚ùå ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'confluence-test-result alert alert-error';
        resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –ü–∞—Ä—Å–∏–Ω–≥ Confluence
document.getElementById('confluenceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = {
        config: {
            url: document.getElementById('confluenceUrl').value,
            username: document.getElementById('confluenceUsername').value,
            password: document.getElementById('confluencePassword').value,
            space_key: document.getElementById('spaceKey').value || null,
            page_ids: document.getElementById('pageIds').value ? 
                      document.getElementById('pageIds').value.split(',').map(id => id.trim()) : null,
            page_urls: document.getElementById('pageUrls').value ? 
                      document.getElementById('pageUrls').value.split('\n')
                          .map(url => url.trim())
                          .filter(url => url.length > 0) : null,
            parse_levels: parseInt(document.getElementById('parseLevels').value),
            verify_ssl: document.getElementById('verifySSL').checked
        },
        max_pages: parseInt(document.getElementById('maxPages').value),
        include_attachments: false,
        parse_child_pages: parseInt(document.getElementById('parseLevels').value) > 1
    };

    const progressDiv = document.getElementById('confluenceProgress');
    const statusDiv = document.getElementById('confluenceStatus');
    
    progressDiv.style.display = 'block';
    statusDiv.textContent = '–ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥...';

    try {
        const response = await fetch('/api/confluence/parse', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
            statusDiv.innerHTML = `‚úÖ ${result.message}`;
            showAlert(`–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${result.processed_pages} —Å—Ç—Ä–∞–Ω–∏—Ü`, 'success');
            refreshStats();
        } else {
            statusDiv.innerHTML = `‚ùå ${result.message}`;
            showAlert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Confluence', 'error');
        }
    } catch (error) {
        statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
        showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');

// Drag & Drop
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
});

fileInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    handleFiles(files);
});

async function handleFiles(files) {
    for (const file of files) {
        await uploadFile(file);
    }
    refreshStats();
}

async function uploadFile(file) {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
        <div>
            <strong>${file.name}</strong><br>
            <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
        </div>
        <div id="status-${file.name}">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    `;
    fileList.appendChild(fileItem);

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        const statusElement = document.getElementById(`status-${file.name}`);

        if (result.status === 'success') {
            statusElement.innerHTML = '‚úÖ –£—Å–ø–µ—à–Ω–æ';
            statusElement.style.color = '#27ae60';
            showAlert(`–§–∞–π–ª ${file.name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
        } else {
            statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
            statusElement.style.color = '#e74c3c';
            showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${result.message}`, 'error');
        }
    } catch (error) {
        const statusElement = document.getElementById(`status-${file.name}`);
        statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        statusElement.style.color = '#e74c3c';
        showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${error.message}`, 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function refreshStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();

        document.getElementById('dbTotalChunks').textContent = stats.total_chunks;
        document.getElementById('dbTotalDocs').textContent = stats.total_documents;

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.querySelectorAll('.stat-number').forEach((el, index) => {
            switch(index) {
                case 0: el.textContent = stats.total_documents; break;
                case 1: el.textContent = stats.total_chunks; break;
                case 2: el.textContent = stats.confluence_pages; break;
                case 3: el.textContent = stats.uploaded_files; break;
            }
        });

        showAlert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
    }
}

// –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function clearDatabase() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        return;
    }

    try {
        const response = await fetch('/api/admin/clear-db', {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showAlert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞', 'success');
            refreshStats();
        } else {
            showAlert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö', 'error');
        }
    } catch (error) {
        showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
    }
}

// =============================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ï–õ–Ø–ú–ò
// =============================================================================

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
async function loadModels() {
    try {
        const response = await fetch('/api/admin/models');
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        const currentModelEl = document.getElementById('currentModel');
        const statusEl = document.getElementById('modelStatus');
        
        if (data.available) {
            currentModelEl.textContent = data.current_model;
            statusEl.textContent = '‚úÖ';
            statusEl.style.color = '#27ae60';
        } else {
            currentModelEl.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            statusEl.textContent = '‚ùå';
            statusEl.style.color = '#e74c3c';
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥–µ–ª–∏
        renderModels(data.models, data.current_model, data.available);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:', error);
        document.getElementById('modelsContainer').innerHTML = 
            '<p style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π</p>';
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
function renderModels(models, currentModel, available) {
    const container = document.getElementById('modelsContainer');
    
    if (!available) {
        container.innerHTML = '<p style="color: #e74c3c;">‚ùå GigaChat —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
        return;
    }
    
    if (!models || models.length === 0) {
        container.innerHTML = '<p>üìù –ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    const modelsHtml = models.map(model => `
        <div class="model-card ${model.name === currentModel ? 'active' : ''} ${!available ? 'disabled' : ''}" 
             onclick="${available ? `selectModel('${model.name}')` : ''}">
            <div class="model-header">
                <span class="model-name">${model.display_name}</span>
                <div class="badges">
                    ${model.is_default ? '<span class="model-badge default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>' : ''}
                    ${model.name === currentModel ? '<span class="model-badge active">–ê–∫—Ç–∏–≤–Ω–∞</span>' : ''}
                </div>
            </div>
            <div style="color: #666; font-size: 14px;">
                ${model.description}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `<div class="model-grid">${modelsHtml}</div>`;
}

// –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
async function selectModel(modelName) {
    try {
        const formData = new FormData();
        formData.append('model_name', modelName);
        
        const response = await fetch('/api/admin/models/set', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(`‚úÖ –ú–æ–¥–µ–ª—å ${modelName} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
            loadModels();
        } else {
            showAlert(`‚ùå ${result.message}`, 'error');
        }
        
    } catch (error) {
        showAlert(`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–¥–µ–ª–∏: ${error.message}`, 'error');
    }
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(refreshStats, 30000);

// =============================================================================
// –ö–û–ù–°–û–õ–¨ –õ–û–ì–û–í
// =============================================================================

let consoleWebSocket = null;
let consolePaused = false;
let maxLogEntries = 1000; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –ª–æ–≥–æ–≤
function connectConsoleWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/logs`;
    
    try {
        consoleWebSocket = new WebSocket(wsUrl);
        
        consoleWebSocket.onopen = function(event) {
            updateConsoleStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            addLogEntry({
                timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
                level: 'INFO',
                logger: 'websocket',
                message: '‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'
            });
        };
        
        consoleWebSocket.onmessage = function(event) {
            if (!consolePaused) {
                try {
                    const logData = JSON.parse(event.data);
                    addLogEntry(logData);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                }
            }
        };
        
        consoleWebSocket.onclose = function(event) {
            updateConsoleStatus(false, '–û—Ç–∫–ª—é—á–µ–Ω–æ');
            addLogEntry({
                timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
                level: 'WARNING',
                logger: 'websocket',
                message: 'üîå WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...'
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(connectConsoleWebSocket, 5000);
        };
        
        consoleWebSocket.onerror = function(error) {
            updateConsoleStatus(false, '–û—à–∏–±–∫–∞');
            addLogEntry({
                timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
                level: 'ERROR',
                logger: 'websocket',
                message: '‚ùå –û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'
            });
        };
        
    } catch (error) {
        updateConsoleStatus(false, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
function addLogEntry(logData) {
    const consoleOutput = document.getElementById('consoleOutput');
    if (!consoleOutput) return;
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${logData.level}`;
    
    logEntry.innerHTML = `
        <span class="log-timestamp">${logData.timestamp}</span>
        <span class="log-logger">[${logData.logger || 'system'}]</span>
        <span class="log-message">${escapeHtml(logData.message)}</span>
    `;
    
    consoleOutput.appendChild(logEntry);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
    while (consoleOutput.children.length > maxLogEntries) {
        consoleOutput.removeChild(consoleOutput.firstChild);
    }
    
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    if (document.getElementById('autoScroll').checked) {
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
function updateConsoleStatus(connected, statusText) {
    const statusDot = document.getElementById('statusDot');
    const statusTextEl = document.getElementById('statusText');
    
    if (statusDot) {
        statusDot.className = `status-dot ${connected ? 'connected' : 'disconnected'}`;
    }
    
    if (statusTextEl) {
        statusTextEl.textContent = statusText;
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—É–∑—ã
function togglePause() {
    consolePaused = !consolePaused;
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (consolePaused) {
        pauseBtn.innerHTML = '‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
        pauseBtn.className = 'console-btn resume';
        addLogEntry({
            timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
            level: 'INFO',
            logger: 'console',
            message: '‚è∏Ô∏è –ö–æ–Ω—Å–æ–ª—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–∞—É–∑—É'
        });
    } else {
        pauseBtn.innerHTML = '‚è∏Ô∏è –ü–∞—É–∑–∞';
        pauseBtn.className = 'console-btn pause';
        addLogEntry({
            timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
            level: 'INFO',
            logger: 'console',
            message: '‚ñ∂Ô∏è –ö–æ–Ω—Å–æ–ª—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞'
        });
    }
}

// –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Å–æ–ª–∏
function clearConsole() {
    const consoleOutput = document.getElementById('consoleOutput');
    if (consoleOutput) {
        consoleOutput.innerHTML = '';
        addLogEntry({
            timestamp: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
            level: 'INFO',
            logger: 'console',
            message: 'üóëÔ∏è –ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞'
        });
    }
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================================================
// –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï
// =============================================================================

// –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
async function runSystemDiagnostics() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...';

    try {
        const response = await fetch('/api/admin/diagnostics', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            contentDiv.innerHTML = formatDiagnosticsResult(result.data);
            updateMaintenanceStatus(result.data);
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è embedding –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
async function checkEmbeddingHealth() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üß† –ü—Ä–æ–≤–µ—Ä–∫–∞ embedding –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞...';

    try {
        const response = await fetch('/api/admin/embedding-health');
        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            contentDiv.innerHTML = `
                ‚úÖ <strong>Embedding –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç</strong><br>
                üìä –ú–æ–¥–µ–ª—å: ${result.data.model}<br>
                ‚ö° –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${result.data.response_time}–º—Å<br>
                üî¢ –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–≤: ${result.data.vector_dimensions}
            `;
            document.getElementById('embeddingStatus').textContent = '‚úÖ';
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
            document.getElementById('embeddingStatus').textContent = '‚ùå';
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
        document.getElementById('embeddingStatus').textContent = '‚ùå';
    }
}

// –û—Ç–ª–∞–¥–∫–∞ GigaChat
async function debugGigaChat() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üêõ –û—Ç–ª–∞–¥–∫–∞ GigaChat...';

    try {
        const response = await fetch('/api/admin/gigachat-debug');
        const result = await response.json();

        if (result.success) {
            const debug = result.debug_info;
            resultDiv.className = 'alert alert-info';
            contentDiv.innerHTML = `
                <h5>üêõ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è GigaChat:</h5>
                <strong>–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong><br>
                üîó URL: ${debug.base_url}<br>
                ü§ñ –ú–æ–¥–µ–ª—å: ${debug.embedding_model}<br>
                ‚úÖ –ö–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: ${debug.client_initialized ? '–î–∞' : '–ù–µ—Ç'}<br>
                üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL: ${debug.mtls_verify_ssl ? '–í–∫–ª—é—á–µ–Ω–∞' : '–û—Ç–∫–ª—é—á–µ–Ω–∞'}<br><br>
                
                <strong>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:</strong><br>
                üìÑ –ü—É—Ç—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É: ${debug.mtls_cert_path}<br>
                üîë –ü—É—Ç—å –∫ –∫–ª—é—á—É: ${debug.mtls_key_path}<br>
                ‚úÖ –§–∞–π–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${debug.cert_file_exists ? '–î–∞' : '–ù–µ—Ç'}<br>
                ‚úÖ –§–∞–π–ª –∫–ª—é—á–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${debug.key_file_exists ? '–î–∞' : '–ù–µ—Ç'}<br>
                ${debug.cert_file_size ? `üìè –†–∞–∑–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: ${debug.cert_file_size} –±–∞–π—Ç<br>` : ''}
                ${debug.key_file_size ? `üìè –†–∞–∑–º–µ—Ä –∫–ª—é—á–∞: ${debug.key_file_size} –±–∞–π—Ç<br>` : ''}<br>
                
                <strong>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong><br>
                üîß –ë–∞–∑–æ–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: ${debug.basic_availability ? 'OK' : 'FAIL'}<br>
                üß† –¢–µ—Å—Ç embedding: ${debug.embedding_test.success ? 'OK' : 'FAIL'}<br>
                ${debug.embedding_test.error ? `‚ùå –û—à–∏–±–∫–∞ embedding: ${debug.embedding_test.error}<br>` : ''}
                ${debug.embedding_test.status_code ? `üì° HTTP –∫–æ–¥: ${debug.embedding_test.status_code}<br>` : ''}
            `;
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ª–∞–¥–∫–∏: ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function validateDatabase() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = '‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...';

    try {
        const response = await fetch('/api/admin/validate-db');
        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            contentDiv.innerHTML = `
                ‚úÖ <strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∞–ª–∏–¥–Ω–∞</strong><br>
                üìä –ö–æ–ª–ª–µ–∫—Ü–∏–π: ${result.data.collections_count}<br>
                üìù –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${result.data.documents_count}<br>
                üîß –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤: ${result.data.index_status}<br>
                üíæ –†–∞–∑–º–µ—Ä: ${result.data.size_mb} MB
            `;
            document.getElementById('chromaStatus').textContent = '‚úÖ';
            document.getElementById('dbSize').textContent = `${result.data.size_mb} MB`;
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
            document.getElementById('chromaStatus').textContent = '‚ùå';
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
        document.getElementById('chromaStatus').textContent = '‚ùå';
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
async function checkMaintenanceNeeds() {
    try {
        const response = await fetch('/api/admin/maintenance-check');
        const result = await response.json();

        const recommendationsDiv = document.getElementById('maintenanceRecommendations');
        
        if (result.success) {
            const data = result.data;
            let statusColor = data.reindexing_needed ? '#f39c12' : '#27ae60';
            
            recommendationsDiv.innerHTML = `
                <h5 style="color: ${statusColor};">
                    ${data.reindexing_needed ? '‚ö†Ô∏è' : '‚úÖ'} 
                    –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
                </h5>
                <p><strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:</strong> ${data.automatic_optimization ? '‚úÖ –í–∫–ª—é—á–µ–Ω–∞' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞'}</p>
                <p><strong>–¢–∏–ø –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:</strong> ${data.maintenance_type}</p>
                <p><strong>–†–µ-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è:</strong> ${data.reindexing_needed ? '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è' : '‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}</p>
                ${data.recommendations ? `<p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong> ${data.recommendations}</p>` : ''}
            `;
        } else {
            recommendationsDiv.innerHTML = `
                <h5 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>
                <p>${result.message}</p>
            `;
        }
    } catch (error) {
        const recommendationsDiv = document.getElementById('maintenanceRecommendations');
        recommendationsDiv.innerHTML = `
            <h5 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h5>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: ${error.message}</p>
        `;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function exportDatabaseInfo() {
    try {
        const response = await fetch('/api/admin/export-metadata');
        const result = await response.json();

        if (result.success) {
            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const dataStr = JSON.stringify(result.data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(dataBlob);
            link.download = `database_metadata_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        } else {
            showAlert(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
async function viewDocumentSources() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üìë –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...';

    try {
        const response = await fetch('/api/admin/document-sources');
        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            const sources = result.data.sources;
            
            let sourcesHtml = '<strong>üìë –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:</strong><br><br>';
            sources.forEach(source => {
                sourcesHtml += `
                    üìÑ <strong>${source.source_type}</strong>: ${source.count} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤<br>
                    ${source.details ? `&nbsp;&nbsp;&nbsp;&nbsp;${source.details}<br>` : ''}
                `;
            });
            
            contentDiv.innerHTML = sourcesHtml;
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
async function analyzeChunkDistribution() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üìä –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤...';

    try {
        const response = await fetch('/api/admin/chunk-analysis');
        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            const analysis = result.data;
            
            contentDiv.innerHTML = `
                <strong>üìä –ê–Ω–∞–ª–∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤:</strong><br><br>
                üìù –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${analysis.total_chunks}<br>
                üìè –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä: ${analysis.avg_chunk_size} —Å–∏–º–≤–æ–ª–æ–≤<br>
                üìê –†–∞–∑–º–µ—Ä –æ—Ç ${analysis.min_chunk_size} –¥–æ ${analysis.max_chunk_size} —Å–∏–º–≤–æ–ª–æ–≤<br>
                üìö –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: ${analysis.unique_sources}<br>
                ${analysis.distribution ? `<br><strong>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º:</strong><br>${analysis.distribution}` : ''}
            `;
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ embeddings
async function checkEmbeddingCompatibility() {
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = '‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ embeddings...';

    try {
        const response = await fetch('/api/admin/embedding-compatibility');
        const result = await response.json();

        if (result.success) {
            const compat = result.data;
            let statusClass = 'alert-success';
            let statusIcon = '‚úÖ';
            
            if (!compat.compatible) {
                statusClass = 'alert-warning';
                statusIcon = '‚ö†Ô∏è';
            }
            
            resultDiv.className = `alert ${statusClass}`;
            contentDiv.innerHTML = `
                <strong>${statusIcon} –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Embeddings:</strong><br><br>
                üß† –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: ${compat.current_model}<br>
                üìê –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–π: ${compat.current_dimension}<br>
                üéØ –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å GigaChat: ${compat.gigachat_dimension}<br>
                ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${compat.compatible ? '–î–∞' : '–ù–µ—Ç'}<br>
                üìä –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ë–î: ${compat.documents_count}<br>
                ${!compat.compatible ? `<br><strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è!</strong><br>` : ''}
                ${compat.migration_needed ? `üîÑ –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞<br>` : ''}
            `;
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –ú–∏–≥—Ä–∞—Ü–∏—è embeddings
async function migrateEmbeddings() {
    if (!confirm('‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å –Ω–æ–≤–æ–π —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å—é. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        return;
    }
    
    const resultDiv = document.getElementById('diagnosticsResult');
    const contentDiv = document.getElementById('diagnosticsContent');
    
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-warning';
    contentDiv.innerHTML = 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è embeddings...<br>‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...';

    try {
        const response = await fetch('/api/admin/migrate-embeddings', {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            resultDiv.className = 'alert alert-success';
            contentDiv.innerHTML = `
                <strong>‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</strong><br><br>
                üîÑ –°—Ç–∞—Ä–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: ${result.data.old_dimension}<br>
                üéØ –ù–æ–≤–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: ${result.data.new_dimension}<br>
                üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${result.data.migrated_documents}<br>
                ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${result.data.duration}—Å<br>
                <br><strong>üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å GigaChat!</strong>
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            setTimeout(() => {
                checkEmbeddingHealth();
                validateDatabase();
            }, 1000);
        } else {
            resultDiv.className = 'alert alert-error';
            contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ${result.message}`;
        }
    } catch (error) {
        resultDiv.className = 'alert alert-error';
        contentDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
function formatDiagnosticsResult(data) {
    let html = '<strong>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</strong><br><br>';
    
    if (data.chromadb) {
        html += `üóÑÔ∏è <strong>ChromaDB:</strong> ${data.chromadb.status}<br>`;
        if (data.chromadb.size_mb) {
            html += `&nbsp;&nbsp;&nbsp;&nbsp;üíæ –†–∞–∑–º–µ—Ä: ${data.chromadb.size_mb} MB<br>`;
        }
    }
    
    if (data.embedding) {
        html += `üß† <strong>Embeddings:</strong> ${data.embedding.status}<br>`;
        if (data.embedding.model) {
            html += `&nbsp;&nbsp;&nbsp;&nbsp;ü§ñ –ú–æ–¥–µ–ª—å: ${data.embedding.model}<br>`;
        }
    }
    
    if (data.documents) {
        html += `üìö <strong>–î–æ–∫—É–º–µ–Ω—Ç—ã:</strong> ${data.documents.total} —à—Ç.<br>`;
        html += `üìù <strong>–§—Ä–∞–≥–º–µ–Ω—Ç—ã:</strong> ${data.documents.chunks} —à—Ç.<br>`;
    }
    
    if (data.recommendations && data.recommendations.length > 0) {
        html += '<br><strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>';
        data.recommendations.forEach(rec => {
            html += `&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ ${rec}<br>`;
        });
    }
    
    return html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
function updateMaintenanceStatus(data) {
    if (data.chromadb && data.chromadb.status === 'OK') {
        document.getElementById('chromaStatus').textContent = '‚úÖ';
    } else {
        document.getElementById('chromaStatus').textContent = '‚ùå';
    }
    
    if (data.embedding && data.embedding.status === 'OK') {
        document.getElementById('embeddingStatus').textContent = '‚úÖ';
    } else {
        document.getElementById('embeddingStatus').textContent = '‚ùå';
    }
    
    // –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
    const allOk = data.chromadb?.status === 'OK' && data.embedding?.status === 'OK';
    document.getElementById('systemStatus').textContent = allOk ? '‚úÖ' : '‚ö†Ô∏è';
    
    // –†–∞–∑–º–µ—Ä –ë–î
    if (data.chromadb?.size_mb) {
        document.getElementById('dbSize').textContent = `${data.chromadb.size_mb} MB`;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π maintenance
function switchTab(tabName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
    if (tabName === 'console' && !consoleWebSocket) {
        connectConsoleWebSocket();
    } else if (tabName === 'models') {
        loadModels();
    } else if (tabName === 'maintenance') {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        setTimeout(() => {
            checkMaintenanceNeeds();
            validateDatabase();
        }, 500);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ï—Å–ª–∏ –∫–æ–Ω—Å–æ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
    const consoleTab = document.getElementById('consoleTab');
    if (consoleTab && consoleTab.classList.contains('active')) {
        connectConsoleWebSocket();
    }
    
    // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –º–æ–¥–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏
    const modelsTab = document.getElementById('modelsTab');
    if (modelsTab && modelsTab.classList.contains('active')) {
        loadModels();
    }
});
</script>
{% endblock %}
